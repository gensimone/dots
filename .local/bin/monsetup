#!/bin/sh

# Handle lock file

LOCK="/tmp/setup-monitor.lock"

trap 'rm -f "$LOCK"; exit 0' SIGINT SIGTERM
if [ -f "$LOCK" ]; then
        echo "Lock file exists: $LOCK"
        exit 1
elif ! touch $LOCK; then
        echo "Could not create lock file: $LOCK"
        exit 1
fi

echo "$$" > $LOCK


# Handle monitor updates

LAP_DEV="eDP-1"
HDMI_DEV="HDMI-1"

update_monitors() {
        if [ $1 == "connected" ]; then
                xrandr --auto
                xrandr --output $HDMI_DEV --primary --right-of $LAP_DEV
        else
                xrandr --auto
        fi
}

PREV=$(xrandr | grep HDMI-1 | cut -d ' ' -f 2)

update_monitors "$PREV"

while true; do
        CUR=$(xrandr | grep HDMI-1 | cut -d ' ' -f 2)
        if [ $CUR != $PREV ]; then
                update_monitors "$CUR"
                PREV=$CUR
        fi
        sleep 3s
done

rm -f "$LOCK"
